$hdr=@"
###############################################
# Remediate-Curl-CVE-2023-38545.ps1
# QID 378936 
# https://msrc.microsoft.com/update-guide/en-US/advisory/CVE-2023-38545
# This script will create a Windows Defender App Control policy to not allow the system to run Curl.exe version 0.0.0.0 to 8.4.0.0
# CAUTION: This script WILL DISABLE curl.exe from running until Microsoft has patched the binary!
# Windows Updates and Store updates have been tested, but use at your own risk!
# As of 11-10-2023, a month after the vulnerability went public, this patch is still not available from Microsoft.
"@

Write-Host "`n$hdr`n"
Write-Host "[.] Checking Windows version information .."
$osVersion = [System.Environment]::OSVersion.Version

# Check if it's Windows 11 or Windows 10 version 1903 and above
if (($osVersion.Major -eq 10 -and $osVersion.Minor -ge 0 -and $osVersion.Build -ge 18362) -or
    ($osVersion.Major -eq 11)) {
    Write-Host "[!] The system is running Windows 11 or Windows 10 version 1903 and above."
    $osversion = 1
}
# Check if it's Windows Server 2022 and above
elseif (($osVersion.Major -eq 10 -and $osVersion.Minor -eq 0 -and $osVersion.Build -ge 20348) -or
    ($osVersion.Major -gt 10)) {
    Write-Host "[!] The system is running Windows Server 2022 and above."
    $osversion = 1
}
else {
    Write-Host "[!] The system is not running any of the specified Windows versions."
    $osversion = 0
}

Write-Host "[.] Creating new WDAC XML rule Deny-Curl.xml .."
$rule = new-cipolicyrule -DriverFilePath "$env:systemroot\system32\curl.exe" -Level FilePublisher -Deny
$rule[0].attributes["MinimumFileVersion"] = "0.0.0.0"
$rule[0].attributes["MaximumFileVersion"] = "8.4.0.0"
merge-cipolicy "$env:systemroot\schemas\CodeIntegrity\ExamplePolicies\AllowAll.xml" -Rules $rule -OutputFilePath "Deny-Curl.xml"

$WDACPolicyXMLFile = "deny-curl.xml"
[xml]$WDACPolicy = Get-Content -Path $WDACPolicyXMLFile
if (($WDACPolicy.SiPolicy.PolicyID) -ne $null) ## Multiple policy format (For Windows builds 1903+ only, including Server 2022)
{
    $PolicyID = $WDACPolicy.SiPolicy.PolicyID
    $PolicyBinary = $PolicyID+".cip"
    Write-Host "[.] Creating Binary policy file $($PolicyId).cip .."
}
else ## Single policy format (Windows Server 2016 and 2019, and Windows 10 1809 LTSC)
{
    Write-Host "[.] Creating Binary policy file SiPolicy.p7b .."
    $PolicyBinary = "SiPolicy.p7b"
}
 
Write-Host "[.] Writing $PolicyBinary to local folder .."
ConvertFrom-CIPolicy -XmlFilePath $WDACPolicyXMLFile -BinaryFilePath $PolicyBinary

Write-Host "[.] Downloading Refreshpolicy.exe from Microsoft .."
$pwd = pwd
wget "https://download.microsoft.com/download/2/d/5/2d598537-6131-40ba-a1e3-f664b97fef6e/RefreshCIPolicy/AMD64/RefreshPolicy(AMD64).exe" -OutFile RefreshPolicy.exe
$RefreshPolicyTool = "$($pwd)\RefreshPolicy.exe"

if ($osversion) {
  Write-Host "[+] Deploying policies for Windows 11, Windows 10 version 1903 and above, and Windows Server 2022 and above .."
  # Policy binary files should be named as {GUID}.cip for multiple policy format files (where {GUID} = <PolicyId> from the Policy XML)
  if ($PolicyBinary) {
    $DestinationFolder = $env:windir+"\System32\CodeIntegrity\CIPolicies\Active\"    
    Copy-Item -Path $PolicyBinary -Destination $DestinationFolder -Force
    if (Test-Path $RefreshPolicyTool) {
      & $RefreshPolicyTool 
    } else {
      Write-Host "RefreshPolicyTool not found: $refreshpolicytool"
    }
  }
} else {
  Write-Host "[+] Deploying policies for all other versions of Windows and Windows Server .."
  # Policy binary files should be named as SiPolicy.p7b for Windows 10 versions earlier than 1903
  if ($PolicyBinary) {
    $DestinationBinary = $env:windir+"\System32\CodeIntegrity\SiPolicy.p7b"
    Copy-Item  -Path $PolicyBinary -Destination $DestinationBinary -Force
    Invoke-CimMethod -Namespace root\Microsoft\Windows\CI -ClassName PS_UpdateAndCompareCIPolicy -MethodName Update -Arguments @{FilePath = $DestinationBinary}
  }
}

Write-Host "[!] Done!"